<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://uicdn.toast.com/grid/latest/tui-grid.css"/>
  <title>ë³€ë™ ì‹ ì²­ ìŠ¹ì¸</title>
  <style>
    /* í•„í„° ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
    #filter-container {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }

    /* ë¼ë²¨ ìŠ¤íƒ€ì¼ */
    #filter-container label {
      font-weight: bold;
    }

    /* ì…€ë ‰íŠ¸ ë°•ìŠ¤ì™€ ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ */
    #filter-container select,
    #filter-container input {
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    /* ì…ë ¥ì°½ í¬ê¸° ì¡°ì • */
    #filter-container input {
      width: 150px;
    }

    /* ë°˜ì‘í˜• ì¡°ì • */
    @media (max-width: 600px) {
      #filter-container {
        flex-direction: column;
        align-items: flex-start;
      }

      #filter-container select,
      #filter-container input {
        width: 100%;
      }
    }
  </style>
</head>
<body>

<div id="filter-container">
  <label for="deptFilter">í•™ê³¼ ì„ íƒ: </label>
  <select id="deptFilter">
    <option value="">ì „ì²´</option>
    <th:block th:each="dept : ${deptList}">
      <option th:value="${dept.deptId}" th:text="${dept.deptName}"></option>
    </th:block>
  </select>

  <label for="nameFilter">ì´ë¦„ ê²€ìƒ‰: </label>
  <input type="text" id="nameFilter" placeholder="ì´ë¦„ ì…ë ¥">

  <label for="afterStateFilter">ë³€ê²½ í›„ ìƒíƒœ: </label>
  <select id="afterStateFilter">
    <option value="">ì „ì²´</option>
    <option value="íœ´í•™">íœ´í•™</option>
    <option value="ì¬í•™">ì¬í•™</option>
    <option value="ìí‡´">ìí‡´</option>
    <option value="í‡´í•™">í‡´í•™</option>
    <option value="ì¡¸ì—…">ì¡¸ì—…</option>
    <option value="ì œì ">ì œì </option>
  </select>
</div>

<div id="change-request-history-grid"></div>

<script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const gridDiv = document.querySelector('#change-request-history-grid');
    const deptFilter = document.querySelector('#deptFilter');
    const nameFilter = document.querySelector('#nameFilter');
    const afterStateFilter = document.querySelector('#afterStateFilter');

    let originalData = []; // ì›ë³¸ ë°ì´í„°ë¥¼ ì €ì¥í•  ë³€ìˆ˜
    let instance = null; // TOAST UI Grid ì¸ìŠ¤í„´ìŠ¤

    createChangeHistoryGrid(gridDiv);

    // í•„í„°ë§ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
    deptFilter.addEventListener('change', filterGrid);
    nameFilter.addEventListener('input', filterGrid);
    afterStateFilter.addEventListener('change', filterGrid);

    function createChangeHistoryGrid(gridDiv) {
      const columns = [
        {header: 'í•™ë²ˆ', name: 'memberId', align: 'center'},
        {header: 'ì´ë¦„', name: 'name', align: 'center'},
        {header: 'í•™ë…„', name: 'grade', align: 'center'},
        {header: 'í•™ê³¼', name: 'deptName', align: 'center'},
        {header: 'ë³€ê²½ ì „ ìƒíƒœ', name: 'beforeState', align: 'center'},
        {header: 'ë³€ê²½ í›„ ìƒíƒœ', name: 'afterState', align: 'center'},
        {header: 'ìŠ¹ì¸ ë‚ ì§œ', name: 'approvalDate', align: 'center'}
      ];

      fetch('/api/admin/change-request-history')
              .then(response => {
                if (!response.ok) {
                  throw new Error('ë„¤íŠ¸ì›Œí¬ ì‘ë‹µì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' + response.statusText);
                }
                return response.json();
              })
              .then(data => {
                originalData = data.map(history => ({
                  memberId: history.memberId,
                  name: history.name,
                  grade: history.grade,
                  deptId: history.deptId,      // ğŸ”¹ deptId ì¶”ê°€
                  deptName: history.deptName,
                  beforeState: history.beforeState,
                  afterState: history.afterState,
                  approvalDate: history.approvalDate
                }));

                renderGrid(gridDiv, originalData, columns);
              })
              .catch(error => {
                console.error('ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:', error);
              });
    }

    function renderGrid(gridDiv, data, columns) {
      if (instance !== null) {
        instance.destroy();
        instance = null;
      }
      instance = new tui.Grid({
        el: gridDiv,
        columns: columns,
        data: data
      });
    }

    function filterGrid() {
      const selectedDeptId = deptFilter.value;  // ì„ íƒí•œ í•™ê³¼ì˜ ID
      const nameKeyword = nameFilter.value.trim().toLowerCase();
      const selectedAfterState = afterStateFilter.value;

      const filteredData = originalData.filter(item => {
        return (selectedDeptId === "" || item.deptId.toString() === selectedDeptId) &&  // deptIdë¡œ ë¹„êµ
                (nameKeyword === "" || item.name.toLowerCase().includes(nameKeyword)) &&
                (selectedAfterState === "" || item.afterState === selectedAfterState);
      });

      renderGrid(gridDiv, filteredData, instance.getColumns());
    }
  });
</script>
</body>
</html>
