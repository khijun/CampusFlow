<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://uicdn.toast.com/grid/latest/tui-grid.css"/>
  <title>변동 신청 승인</title>
  <style>
    /* 필터 컨테이너 스타일 */
    #filter-container {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }

    /* 라벨 스타일 */
    #filter-container label {
      font-weight: bold;
    }

    /* 셀렉트 박스와 입력창 스타일 */
    #filter-container select,
    #filter-container input {
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    /* 입력창 크기 조정 */
    #filter-container input {
      width: 150px;
    }

    /* 반응형 조정 */
    @media (max-width: 600px) {
      #filter-container {
        flex-direction: column;
        align-items: flex-start;
      }

      #filter-container select,
      #filter-container input {
        width: 100%;
      }
    }
  </style>
</head>
<body>

<div id="filter-container">
  <label for="deptFilter">학과 선택: </label>
  <select id="deptFilter">
    <option value="">전체</option>
    <th:block th:each="dept : ${deptList}">
      <option th:value="${dept.deptId}" th:text="${dept.deptName}"></option>
    </th:block>
  </select>

  <label for="nameFilter">이름 검색: </label>
  <input type="text" id="nameFilter" placeholder="이름 입력">

  <label for="afterStateFilter">변경 후 상태: </label>
  <select id="afterStateFilter">
    <option value="">전체</option>
    <option value="휴학">휴학</option>
    <option value="재학">재학</option>
    <option value="자퇴">자퇴</option>
    <option value="퇴학">퇴학</option>
    <option value="졸업">졸업</option>
    <option value="제적">제적</option>
  </select>
</div>

<div id="change-request-history-grid"></div>

<script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const gridDiv = document.querySelector('#change-request-history-grid');
    const deptFilter = document.querySelector('#deptFilter');
    const nameFilter = document.querySelector('#nameFilter');
    const afterStateFilter = document.querySelector('#afterStateFilter');

    let originalData = []; // 원본 데이터를 저장할 변수
    let instance = null; // TOAST UI Grid 인스턴스

    createChangeHistoryGrid(gridDiv);

    // 필터링 이벤트 리스너 추가
    deptFilter.addEventListener('change', filterGrid);
    nameFilter.addEventListener('input', filterGrid);
    afterStateFilter.addEventListener('change', filterGrid);

    function createChangeHistoryGrid(gridDiv) {
      const columns = [
        {header: '학번', name: 'memberId', align: 'center'},
        {header: '이름', name: 'name', align: 'center'},
        {header: '학년', name: 'grade', align: 'center'},
        {header: '학과', name: 'deptName', align: 'center'},
        {header: '변경 전 상태', name: 'beforeState', align: 'center'},
        {header: '변경 후 상태', name: 'afterState', align: 'center'},
        {header: '승인 날짜', name: 'approvalDate', align: 'center'}
      ];

      fetch('/api/admin/change-request-history')
              .then(response => {
                if (!response.ok) {
                  throw new Error('네트워크 응답이 실패했습니다.' + response.statusText);
                }
                return response.json();
              })
              .then(data => {
                originalData = data.map(history => ({
                  memberId: history.memberId,
                  name: history.name,
                  grade: history.grade,
                  deptId: history.deptId,      // 🔹 deptId 추가
                  deptName: history.deptName,
                  beforeState: history.beforeState,
                  afterState: history.afterState,
                  approvalDate: history.approvalDate
                }));

                renderGrid(gridDiv, originalData, columns);
              })
              .catch(error => {
                console.error('데이터를 가져오는 중 오류가 발생했습니다:', error);
              });
    }

    function renderGrid(gridDiv, data, columns) {
      if (instance !== null) {
        instance.destroy();
        instance = null;
      }
      instance = new tui.Grid({
        el: gridDiv,
        columns: columns,
        data: data
      });
    }

    function filterGrid() {
      const selectedDeptId = deptFilter.value;  // 선택한 학과의 ID
      const nameKeyword = nameFilter.value.trim().toLowerCase();
      const selectedAfterState = afterStateFilter.value;

      const filteredData = originalData.filter(item => {
        return (selectedDeptId === "" || item.deptId.toString() === selectedDeptId) &&  // deptId로 비교
                (nameKeyword === "" || item.name.toLowerCase().includes(nameKeyword)) &&
                (selectedAfterState === "" || item.afterState === selectedAfterState);
      });

      renderGrid(gridDiv, filteredData, instance.getColumns());
    }
  });
</script>
</body>
</html>
