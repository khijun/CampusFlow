<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>수강신청</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f4f4f4;
        }
        .full {
            color: red;
        }
        .available {
            color: green;
        }
    </style>
</head>
<body>
    <h2>수강신청 가능 강의 목록</h2>
    
    <table>
        <thead>
            <tr>
                <th>강의명</th>
                <th>담당교수</th>
                <th>학과</th>
                <th>이수구분</th>
                <th>학점</th>
                <th>강의시간</th>
                <th>강의실</th>
                <th>수강인원</th>
                <th>신청</th>
            </tr>
        </thead>
        <tbody>
            <tr th:each="lecture : ${lectures}">
                <td th:text="${lecture.lectureName}"></td>
                <td th:text="${lecture.name}"></td>
                <td th:text="${lecture.deptName}"></td>
                <td th:text="${lecture.subjectType}"></td>
                <td th:text="${lecture.subjectCredits}"></td>
                <td th:text="${lecture.lectureDay + ' ' + lecture.startTime + '-' + lecture.endTime}"></td>
                <td th:text="${lecture.facilityName}"></td>
                <td>
                    <span th:text="${lecture.currentStudents + '/' + lecture.maxStudents}"></span>
                    <span th:class="${lecture.currentStudents >= lecture.maxStudents ? 'full' : 'available'}">
                        [(${lecture.currentStudents >= lecture.maxStudents ? '(마감)' : '(신청가능)'})]
                    </span>
                </td>
                <td>
                    <button th:if="${lecture.currentStudents < lecture.maxStudents}"
                            th:onclick="'registerLecture(' + ${lecture.lectureId} + ')'">
                        신청
                    </button>
                    <span th:if="${lecture.currentStudents >= lecture.maxStudents}">마감</span>
                </td>
            </tr>
        </tbody>
    </table>

    <script>
        function registerLecture(lectureId) {
            if (confirm('이 강의를 수강신청 하시겠습니까?')) {
                // 신청 상태를 REQUESTED로 설정하기 위한 데이터
                const data = {
                    lectureId: lectureId,
                    regStatus: 'REQUESTED' // 공통 코드의 신청 상태
                };

                fetch('/iframe/ofregistration/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)  // 수정된 데이터 전송
                })
                    .then(response => {
                        if (response.ok) {
                            alert('수강신청이 완료되었습니다.');
                            location.reload();
                        } else {
                            return response.text().then(text => {
                                throw new Error(text);
                            });
                        }
                    })
                    .catch(error => {
                        alert('수강신청 실패: ' + error.message);
                    });
            }
        }
    </script>
</body>
</html>