<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>êµìˆ˜ ì¶œê²° ì¡°íšŒ</title>
    <link rel="stylesheet" href="https://uicdn.toast.com/grid/latest/tui-grid.css"/>
    <link th:href="@{/css/iframe/curriculum/subject/toastUi_grid.css}" rel="stylesheet">
    <link th:href="@{/css/iframe/curriculum/search-container.css}" rel="stylesheet">
    <style>
        .large-circle {
            font-size: 26px;
            font-weight: bold;
            text-align: center;
        }
    </style>
</head>
<body>
<div>
    <h1>êµìˆ˜ ì¶œê²° ì¡°íšŒ</h1>
    <div class="search-container">
        <div class="input-group">
            <label for="year-select">ë…„ë„:</label>
            <select id="year-select" class="input-field">
                <option value="2023">2023</option>
                <option value="2024">2024</option>
                <option value="2025" selected>2025</option>
            </select>
        </div>

        <div class="input-group">
            <label for="semester-select">í•™ê¸°:</label>
            <select id="semester-select" class="input-field">
                <option value="88">1í•™ê¸°</option>
                <option value="89">2í•™ê¸°</option>
            </select>
        </div>

        <div class="input-group">
            <label for="lecture-select">ê°•ì˜:</label>
            <select id="lecture-select" class="input-field">
            </select>
        </div>

        <button id="attendance-search-btn" class="btn">ì¡°íšŒ</button>
    </div>
    <div class="attendance-legend" style="text-align: right; margin-right: 20px;">
        <span class="legend-item">ì¶œì„ : â—‹</span>
        <span class="legend-item">ì§€ê° : â–³</span>
        <span class="legend-item">ê²°ì„ : X</span>
    </div>
    <div id="attendance-grid-container" style="height: 700px; margin-top: 10px;"></div>
</div>

<script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>
<script>
    let grid;

    function formatAttendanceStatus(status) {
        if (!status) return "-"; // NULL ê°’ ì²˜ë¦¬
        const statusMap = {
            "P": "<span class='large-circle'>â—‹</span>",
            "L": "â–³",
            "A": "X"
        };
        return statusMap[status.toString()] || "-";
    }

    function calculateAttendanceScore(attendance, late, absent) {
        let penalty = Math.floor((late || 0) / 3) + (absent || 0);
        return Math.max(10 - penalty * 0.5, 0).toFixed(1);
    }

    document.getElementById("attendance-search-btn").addEventListener("click", () => {
        const year = document.getElementById("year-select").value;
        const semester = document.getElementById("semester-select").value;
        const lectureId = document.getElementById("lecture-select").value;

        if (!lectureId) {
            alert("ê°•ì˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
            return;
        }

        fetch(`/attendance/api/professor?year=${encodeURIComponent(year)}&semester=${encodeURIComponent(semester)}&lectureId=${encodeURIComponent(lectureId)}`)
            .then(response => response.json())
            .then(data => {
                if (grid) {
                    grid.destroy();
                }

                data.forEach(row => {
                    row.attendanceScore = calculateAttendanceScore(row.attendanceCount, row.lateCount, row.absentCount);
                    for (let i = 1; i <= 15; i++) {
                        row[`week${i}`] = formatAttendanceStatus(row[`week${i}`]);
                    }
                });

                grid = new tui.Grid({
                    el: document.getElementById('attendance-grid-container'),
                    data: data,
                    columns: [
                        { header: 'í•™ë²ˆ', name: 'studentId', width: 202, align: 'center' },
                        { header: 'í•™ìƒ ì´ë¦„', name: 'studentName', width: 200, align: 'center' },
                        { header: 'ì¶œì„', name: 'attendanceCount', width: 100, align: 'center' },
                        { header: 'ì§€ê°', name: 'lateCount', width: 100, align: 'center' },
                        { header: 'ê²°ì„', name: 'absentCount', width: 100, align: 'center' },
                        { header: '1ì£¼ì°¨', name: 'week1', width: 50, align: 'center' },
                        { header: '2ì£¼ì°¨', name: 'week2', width: 50, align: 'center' },
                        { header: '3ì£¼ì°¨', name: 'week3', width: 50, align: 'center' },
                        { header: '4ì£¼ì°¨', name: 'week4', width: 50, align: 'center' },
                        { header: '5ì£¼ì°¨', name: 'week5', width: 50, align: 'center' },
                        { header: '6ì£¼ì°¨', name: 'week6', width: 50, align: 'center' },
                        { header: '7ì£¼ì°¨', name: 'week7', width: 50, align: 'center' },
                        { header: '8ì£¼ì°¨', name: 'week8', width: 50, align: 'center' },
                        { header: '9ì£¼ì°¨', name: 'week9', width: 50, align: 'center' },
                        { header: '10ì£¼ì°¨', name: 'week10', width: 50, align: 'center' },
                        { header: '11ì£¼ì°¨', name: 'week11', width: 50, align: 'center' },
                        { header: '12ì£¼ì°¨', name: 'week12', width: 50, align: 'center' },
                        { header: '13ì£¼ì°¨', name: 'week13', width: 50, align: 'center' },
                        { header: '14ì£¼ì°¨', name: 'week14', width: 50, align: 'center' },
                        { header: '15ì£¼ì°¨', name: 'week15', width: 50, align: 'center' },
                        { header: 'ì¶œì„ ì ìˆ˜', name: 'attendanceScore', width: 200, align: 'center' }
                    ],
                    bodyHeight: 'fitToParent'
                });
            })
            .catch(error => {
                console.error("ì¶œê²° ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:", error);
                alert("ì¶œê²° ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            });
    });

    // ğŸ”¹ ë¡œê·¸ì¸ëœ êµìˆ˜(member_id) ê¸°ì¤€ìœ¼ë¡œ ê°•ì˜ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    window.onload = function() {
        fetch("/attendance/api/professor/lectures")
            .then(response => {
                if (!response.ok) {
                    throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${response.status}`);
                }
                return response.json();
            })
            .then(lectures => {
                if (!Array.isArray(lectures)) {
                    throw new Error("ê°•ì˜ ëª©ë¡ì´ ë°°ì—´ì´ ì•„ë‹™ë‹ˆë‹¤.");
                }
                const lectureSelect = document.getElementById("lecture-select");
                lectureSelect.innerHTML = "<option value=''>ê°•ì˜ ì„ íƒ</option>";

                lectures.forEach(lecture => {
                    const option = document.createElement("option");
                    option.value = lecture.lectureId;
                    option.textContent = lecture.lectureName;
                    lectureSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error("ê°•ì˜ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨:", error);
                alert(`ê°•ì˜ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`);
            });
    };

</script>
</body>
</html>
