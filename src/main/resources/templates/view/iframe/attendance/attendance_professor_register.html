<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ì¶œì„ ë“±ë¡ (êµìˆ˜ìš©)</title>
    <link rel="stylesheet" href="https://uicdn.toast.com/grid/latest/tui-grid.css"/>
    <link th:href="@{/css/iframe/curriculum/subject/toastUi_grid.css}" rel="stylesheet">
    <link th:href="@{/css/iframe/curriculum/search-container.css}" rel="stylesheet">
    <style>
        .large-circle {
            font-size: 26px;
            font-weight: bold;
            text-align: center;
        }
        .save-button {
            background-color: #3498db;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            float: right;
            margin-top: 10px;
        }
        .save-button:hover {
            background-color: #2980b9;
        }
    </style>
</head>
<body>
<div>
    <h1>ì¶œì„ ë“±ë¡ (êµìˆ˜ìš©)</h1>
    <div class="search-container">
        <div class="input-group">
            <label for="year-select">ë…„ë„:</label>
            <select id="year-select" class="input-field">
                <option value="2023">2023</option>
                <option value="2024">2024</option>
                <option value="2025" selected>2025</option>
            </select>
        </div>

        <div class="input-group">
            <label for="semester-select">í•™ê¸°:</label>
            <select id="semester-select" class="input-field">
                <option value="88">1í•™ê¸°</option>
                <option value="89">2í•™ê¸°</option>
            </select>
        </div>

        <div class="input-group">
            <label for="lecture-select">ê°•ì˜:</label>
            <select id="lecture-select" class="input-field">
            </select>
        </div>

        <button id="attendance-search-btn" class="btn">ì¡°íšŒ</button>
    </div>

    <div class="attendance-legend" style="text-align: right; margin-right: 20px;">
        <span class="legend-item">ì¶œì„ : â—‹</span>
        <span class="legend-item">ì§€ê° : â–³</span>
        <span class="legend-item">ê²°ì„ : X</span>
    </div>
    <button id="save-attendance-btn" class="save-button" style="margin-right: 20px; margin-bottom: 10px">ì¶œì„ ì €ì¥</button>


    <div id="attendance-grid-container" style="height: 700px; margin-top: 10px;"></div>

</div>

<script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>
<script>
    let grid;

    window.onload = function() {
        fetch("/attendance/api/professor/lectures")
            .then(response => response.json())
            .then(lectures => {
                console.log("ğŸ”¹ ê°•ì˜ ëª©ë¡:", lectures);
                const lectureSelect = document.getElementById("lecture-select");
                lectureSelect.innerHTML = "<option value=''>ê°•ì˜ ì„ íƒ</option>";

                lectures.forEach(lecture => {
                    const option = document.createElement("option");
                    option.value = lecture.lectureId;
                    option.textContent = lecture.lectureName;
                    lectureSelect.appendChild(option);
                });
            })
            .catch(error => alert(`ê°•ì˜ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${error.message}`));
    };

    document.getElementById("attendance-search-btn").addEventListener("click", () => {
        const year = document.getElementById("year-select").value;
        const semester = document.getElementById("semester-select").value;
        const lectureId = document.getElementById("lecture-select").value;

        if (!lectureId) {
            alert("ê°•ì˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
            return;
        }

        fetch(`/attendance/api/professor?year=${year}&semester=${semester}&lectureId=${lectureId}`)
            .then(response => response.json())
            .then(data => {
                if (grid) {
                    grid.destroy();
                }

                grid = new tui.Grid({
                    el: document.getElementById('attendance-grid-container'),
                    data: data,
                    columns: [
                        { header: 'í•™ë²ˆ', name: 'studentId', width: 150, align: 'center', readOnly: true },
                        { header: 'í•™ìƒ ì´ë¦„', name: 'studentName', width: 150, align: 'center', readOnly: true },
                        { header: 'ì¶œì„', name: 'attendanceCount', width: 80, align: 'center', readOnly: true },
                        { header: 'ì§€ê°', name: 'lateCount', width: 80, align: 'center', readOnly: true },
                        { header: 'ê²°ì„', name: 'absentCount', width: 80, align: 'center', readOnly: true },
                        ...Array.from({ length: 15 }, (_, i) => ({
                            header: `${i + 1}ì£¼ì°¨`,
                            name: `week${i + 1}`,
                            width: 50,
                            align: 'center',
                            editor: {
                                type: 'select',
                                options: { listItems: [{ text: "P", value: "P" }, { text: "L", value: "L" }, { text: "A", value: "A" }, { text: "-", value: "-" }] }
                            }
                        })),
                        { header: 'ì¶œì„ ì ìˆ˜', name: 'attendanceScore', width: 100, align: 'center', readOnly: true }
                    ],
                    bodyHeight: 'fitToParent'
                });
            })
            .catch(error => alert("ì¶œê²° ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."));
    });

    document.getElementById("save-attendance-btn").addEventListener("click", () => {
        if (!grid) {
            alert("ì¶œê²° ë°ì´í„°ë¥¼ ë¨¼ì € ì¡°íšŒí•´ì£¼ì„¸ìš”.");
            return;
        }

        const lectureId = document.getElementById("lecture-select").value;
        if (!lectureId) {
            alert("ê°•ì˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
            return;
        }

        const updatedData = grid.getData().map(row => ({
            studentId: row.studentId,
            lectureId: lectureId,
            week1: row.week1, week2: row.week2, week3: row.week3, week4: row.week4, week5: row.week5,
            week6: row.week6, week7: row.week7, week8: row.week8, week9: row.week9, week10: row.week10,
            week11: row.week11, week12: row.week12, week13: row.week13, week14: row.week14, week15: row.week15
        }));

        fetch(`/attendance/api/professor/update?lectureId=${lectureId}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(updatedData)
        })
            .then(response => response.text())
            .then(message => alert(message))
            .catch(error => alert("ì¶œê²° ì •ë³´ ì €ì¥ ì‹¤íŒ¨: " + error));
    });

</script>
</body>
</html>
