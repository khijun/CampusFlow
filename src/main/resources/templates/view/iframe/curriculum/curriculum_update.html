<!DOCTYPE html>
<<<<<<< HEAD
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>교육과정 등록</title>
   <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700&display=swap" rel="stylesheet">
   <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet">
   <link th:href="@{/css/iframe/curriculum/search-container.css}" rel="stylesheet">
</head>
<body>
<div class="container">
   <!-- 검색 컨테이너 -->
   <form class="search-container" th:action="@{/iframe/curriculum/update}" method="get">
      <div class="input-group">
         <label for="year">학년도</label>
         <select id="year" name="year">
            <option value="">전체</option>
            <option value="2023">2023</option>
            <option value="2024">2024</option>
            <option value="2025">2025</option>
         </select>
      </div>
      <div class="input-group">
         <label for="grade">편성학년</label>
         <select id="grade" name="grade">
            <option value="">전체</option>
            <option value="GRADE_1">1학년</option>
            <option value="GRADE_2">2학년</option>
            <option value="GRADE_3">3학년</option>
            <option value="GRADE_4">4학년</option>
         </select>
      </div>
      <div class="input-group">
         <label for="deptName">학과 이름</label>
         <input type="text" id="deptName" name="deptName" placeholder="예: 컴퓨터공학과">
      </div>
      <div class="input-group">
         <label for="curriculumName">교육과정명</label>
         <input type="text" id="curriculumName" name="curriculumName" placeholder="예: 프로그래밍 기초">
      </div>
      <div class="input-group">
         <label for="category">교육과정 상태</label>
         <select id="category" name="category">
            <option value="">전체</option>
            <option value="active">운영중(활성화)</option>
            <option value="inactive">운영중단(비활성화)</option>
            <option value="deprecated">폐지(사용중단)</option>
         </select>
      </div>
      <div class="button-group">
         <button type="submit">검색</button>
      </div>
   </form>

   <!-- 검색 결과 컨테이너 -->
   <div class="result-container">
      <div class="result-header">
         <div>학년도</div>
         <div>편성학년</div>
         <div>학과 이름</div>
         <div>교육과정명</div>
         <div>교육과정 상태</div>
      </div>
      <div th:if="${results != null}" th:each="curriculum : ${results}" class="result-row">
         <div th:text="${curriculum.curriculumYear ?: 'N/A'}"></div>
         <div th:text="${curriculum.grade?.codeName ?: 'N/A'}"></div>
         <div th:text="${curriculum.dept?.deptName ?: 'N/A'}"></div>
         <div th:text="${curriculum.curriculumName ?: 'N/A'}"></div>
         <div th:text="${curriculum.curriculumStatus?.codeName ?: 'N/A'}"></div>
      </div>
      <div th:each="curriculum : ${results}"></div>
   </div>
</div>
<script src="/js/curriculum/searchSubject.js"></script>
<script src="/js/curriculum/toggleAddContainer.js"></script> <!-- 경로를 /static/js/ 대신 /js/로 수정 -->
=======
<html lang="ko">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1">
   <link rel="stylesheet" href="https://uicdn.toast.com/grid/latest/tui-grid.css"/>
   <link th:href="@{/css/iframe/curriculum/subject/toastUi_grid.css}" rel="stylesheet">
   <title>교육과정 수정</title>
</head>
<body>
<div>
   <div class="list-option-container">
      <input id="curriculum-name-input" type="text" placeholder="교육과정 이름을 입력하세요" />
      <button id="curriculum-list-select-btn">조회</button>
      <button id="save-updates-btn">수정 저장</button>
      <button id="delete-selected-btn">삭제</button>
   </div>
   <div id="curriculum-grid-container" style="height: 700px;"></div>
</div>

<script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>
<script>
   let grid = null;

   document.addEventListener("DOMContentLoaded", async function () {
      await loadCommonCodes();
      setupEventListeners();
   });

   async function fetchCommonCodes(groupCode) {
      try {
         const response = await fetch(`/api/common-codes/${groupCode}`);
         return response.ok ? await response.json() : [];
      } catch {
         return [];
      }
   }

   async function loadCommonCodes() {
      const [gradeOptions, statusOptions, semesterOptions, dayNightOptions] = await Promise.all([
         fetchCommonCodes("GRADE"),
         fetchCommonCodes("CURRICULUMSTATUS"),
         fetchCommonCodes("SEMESTER"),
         fetchCommonCodes("DAY_NIGHT")
      ]);

      function transformOptions(options) {
         return (options ?? []).map(opt => ({ text: opt.codeName, value: opt.codeValue }));
      }

      window.gradeList = transformOptions(gradeOptions);
      window.statusList = transformOptions(statusOptions);
      window.semesterList = transformOptions(semesterOptions);
      window.dayNightList = transformOptions(dayNightOptions);
   }

   function getCodeValue(codeList, codeValue) {
      return codeList?.find(opt => opt.value === codeValue)?.value || null;
   }

   function setupEventListeners() {
      document.getElementById("curriculum-list-select-btn").addEventListener("click", fetchCurriculums);
      document.getElementById("save-updates-btn").addEventListener("click", saveUpdates);
      document.getElementById("delete-selected-btn").addEventListener("click", deleteSelectedRows);
   }

   async function fetchCurriculums() {
      const keyword = document.getElementById("curriculum-name-input").value.trim();

      try {
         const response = await fetch(`/api/curriculums?keyword=${encodeURIComponent(keyword)}`);
         const data = response.ok ? await response.json() : [];

         if (grid) grid.destroy();

         grid = new tui.Grid({
            el: document.getElementById("curriculum-grid-container"),
            data: data,
            columns: [
               { header: "교육과정 ID", name: "curriculumId", align: "center", width: 80, readOnly: true },
               { header: "학과 ID", name: "deptId", align: "center", width: 80, readOnly: true },
               { header: "학과명", name: "deptName", align: "center", width: 200, readOnly: true },
               { header: "교육과정명", name: "curriculumName", editor: "text", width: 300 },
               { header: "연도", name: "curriculumYear", align: "center", editor: "text", width: 100 },
               { header: "학년", name: "grade", formatter: item => gradeList.find(opt => opt.value === item.value)?.text || item.value, editor: { type: "select", options: { listItems: gradeList } }, align: "center", width: 100 },
               { header: "상태", name: "curriculumStatus", formatter: item => statusList.find(opt => opt.value === item.value)?.text || item.value, editor: { type: "select", options: { listItems: statusList } }, align: "center", width: 100 },
               { header: "학기", name: "semester", formatter: item => semesterList.find(opt => opt.value === item.value)?.text || item.value, editor: { type: "select", options: { listItems: semesterList } }, align: "center", width: 100 },
               { header: "주야 구분", name: "dayNight", formatter: item => dayNightList.find(opt => opt.value === item.value)?.text || item.value, editor: { type: "select", options: { listItems: dayNightList } }, align: "center", width: 100 },
               { header: "사유", name: "reason", editor: "text", width: 430 }
            ],
            bodyHeight: "fitToParent",
            rowHeaders: ["checkbox"],
            editingEvent: "click"
         });

      } catch {
         alert("데이터를 불러오는 데 실패했습니다.");
      }
   }

   function saveUpdates() {
      const updatedRows = grid.getModifiedRows().updatedRows;
      if (updatedRows.length === 0) return alert("수정된 데이터가 없습니다.");

      const formattedData = updatedRows.map(row => ({
         curriculumId: row.curriculumId || null,
         deptId: row.deptId || null,
         curriculumName: row.curriculumName || "미정",
         curriculumYear: row.curriculumYear || new Date().getFullYear(),
         grade: getCodeValue(gradeList, row.grade) || "GRADE_1",
         curriculumStatus: getCodeValue(statusList, row.curriculumStatus) || "ACTIVE",
         semester: getCodeValue(semesterList, row.semester) || "FIRST_SEMESTER",
         dayNight: getCodeValue(dayNightList, row.dayNight) || "DAY",
         reason: row.reason || "기본값"
      }));

      fetch("/api/curriculums/update", {
         method: "PUT",
         headers: { "Content-Type": "application/json" },
         body: JSON.stringify(formattedData)
      })
              .then(response => response.ok ? response.json() : Promise.reject())
              .then(() => {
                 alert("데이터가 수정되었습니다");
                 fetchCurriculums();
              })
              .catch(() => alert("수정 저장 중 오류가 발생했습니다."));
   }

   function deleteSelectedRows() {
      if (!grid) return alert("먼저 교육과정을 조회하세요.");

      const selectedRows = grid.getCheckedRows();
      if (selectedRows.length === 0) return alert("삭제할 데이터를 선택하세요.");

      const idsToDelete = selectedRows.map(row => row.curriculumId);

      fetch("/api/curriculums/delete", {
         method: "DELETE",
         headers: { "Content-Type": "application/json" },
         body: JSON.stringify(idsToDelete)
      })
              .then(response => response.ok ? response.json() : Promise.reject())
              .then(() => {
                 alert("데이터가 삭제되었습니다");
                 grid.resetData(grid.getData().filter(row => !idsToDelete.includes(row.curriculumId)));
              })
              .catch(() => alert("데이터 삭제 중 오류가 발생했습니다."));
   }
</script>
>>>>>>> a7516feb8ff654da47c92b90d6ecdf6b3176fac9
</body>
</html>
